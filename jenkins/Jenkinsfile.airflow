pipeline {
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    jenkins: agent
spec:
  serviceAccountName: jenkins
  containers:
  - name: python
    image: python:3.11-slim
    command:
    - cat
    tty: true
    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
      limits:
        memory: "2Gi"
        cpu: "1000m"
'''
        }
    }
    
    environment {
        DAGS_DIR = 'dags'
        AIRFLOW_URL = 'https://airflow.ducttdevops.com'
        AIRFLOW_DAG_ID = "${env.AIRFLOW_DAG_ID ?: 'sales_analytics_pipeline'}"
        AIRFLOW_USER = 'admin'
        AIRFLOW_PASS = 'admin'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Test DAG') {
            steps {
                container('python') {
                    script {
                        echo "============================================================"
                        echo "Testing DAG: ${AIRFLOW_DAG_ID}"
                        echo "============================================================"
                        
                        sh """
                            set -e
                            
                            # Install dependencies with constraint file
                            pip install --upgrade pip --quiet
                            pip install apache-airflow==2.8.0 apache-airflow-providers-postgres --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.8.0/constraints-3.11.txt" --quiet 2>&1 | grep -v WARNING || true
                            
                            # Test 1: Check DAG file exists
                            echo ""
                            echo "============================================================"
                            echo "TEST 1: Checking if DAG file exists"
                            echo "============================================================"
                            if [ ! -f "dags/sale_analytics.py" ]; then
                                echo "‚ùå DAG file not found: dags/sale_analytics.py"
                                exit 1
                            fi
                            echo "‚úÖ DAG file found: dags/sale_analytics.py"
                            
                            # Test 2: Validate Python syntax
                            echo ""
                            echo "============================================================"
                            echo "TEST 2: Validating Python syntax"
                            echo "============================================================"
                            python -m py_compile dags/sale_analytics.py
                            echo "‚úÖ Python syntax is valid"
                            
                            # Test 3: Test DAG import and structure
                            echo ""
                            echo "============================================================"
                            echo "TEST 3: Testing DAG import"
                            echo "============================================================"
                            
                            export AIRFLOW_HOME=/tmp/airflow
                            export AIRFLOW__CORE__LOAD_EXAMPLES=False
                            export AIRFLOW__CORE__UNIT_TEST_MODE=True
                            
                            python << 'PYTHON_SCRIPT'
import sys
import os
from pathlib import Path

# Verify airflow installation
try:
    import airflow
    print(f"‚úÖ Airflow version: {airflow.__version__}")
    print(f"‚úÖ Airflow location: {airflow.__file__}")
except ImportError as e:
    print(f"‚ùå Cannot import airflow: {e}")
    sys.exit(1)

# Import Airflow classes
try:
    from airflow import DAG
    from airflow.models import DagBag
    print("‚úÖ Airflow DAG class imported")
except ImportError as e:
    print(f"‚ùå Cannot import DAG class: {e}")
    sys.exit(1)

# Set DAG file path
dag_file = "dags/sale_analytics.py"
expected_dag_id = "sales_analytics_pipeline"

try:
    # Use DagBag to load DAG
    print(f"Loading DAG from: {os.path.abspath(dag_file)}")
    
    # Create a DagBag with the dags folder
    dagbag = DagBag(dag_folder="dags", include_examples=False)
    
    if dagbag.import_errors:
        print("‚ùå DAG import errors found:")
        for filename, error in dagbag.import_errors.items():
            print(f"   File: {filename}")
            print(f"   Error: {error}")
        sys.exit(1)
    
    print(f"‚úÖ Module imported successfully")
    
    # Find DAG objects
    if not dagbag.dags:
        print("‚ö†Ô∏è  No DAG objects found in file")
        sys.exit(1)
    
    found_dags = []
    for dag_id, dag in dagbag.dags.items():
        found_dags.append({
            "name": dag_id,
            "dag_id": dag.dag_id,
            "tasks": len(dag.tasks)
        })
    
    print(f"‚úÖ Found {len(found_dags)} DAG(s):")
    for dag_info in found_dags:
        print(f'   - {dag_info["name"]}: dag_id={dag_info["dag_id"]}, tasks={dag_info["tasks"]}')
    
    # Check if requested DAG ID matches
    if expected_dag_id:
        if expected_dag_id in dagbag.dags:
            print(f"‚úÖ Found matching DAG ID: {expected_dag_id}")
            dag = dagbag.dags[expected_dag_id]
            print(f"   Tasks: {', '.join([t.task_id for t in dag.tasks])}")
        else:
            print(f"‚ö†Ô∏è  Requested DAG ID {expected_dag_id} not found")
            print(f"   Available DAG IDs: {list(dagbag.dags.keys())}")
            sys.exit(1)
    
    # Test 4: Validate DAG structure
    print("")
    print("============================================================")
    print("TEST 4: Validating DAG structure")
    print("============================================================")
    
    with open(dag_file, "r") as f:
        content = f.read()
    
    checks = {
        "has_dag_import": "from airflow import DAG" in content or "import airflow" in content,
        "has_dag_definition": "DAG(" in content or "with DAG(" in content,
        "has_tasks": "Operator(" in content or "PythonOperator" in content or "PostgresOperator" in content,
    }
    
    all_passed = True
    for check_name, passed in checks.items():
        status = "‚úÖ" if passed else "‚ùå"
        check_display = check_name.replace("_", " ").title()
        print(f"{status} {check_display}: {passed}")
        if not passed:
            all_passed = False
    
    if not all_passed:
        print("‚ùå DAG structure validation failed")
        sys.exit(1)
    
    print("")
    print("============================================================")
    print("‚úÖ All DAG tests passed!")
    print("============================================================")
    
except Exception as e:
    print(f"‚ùå DAG validation failed: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
PYTHON_SCRIPT
                        """
                    }
                }
            }
        }
        
        stage('Run Airflow DAG') {
            when {
                expression { return currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                container('python') {
                    script {
                        echo "üöÄ Triggering Airflow DAG: ${AIRFLOW_DAG_ID}"
                        
                        sh """
                            pip install requests --quiet 2>&1 | grep -v WARNING || true
                            
                            python << 'PYTHON_SCRIPT'
import requests
import json
import base64
import sys
import os
import urllib3

# Disable SSL warnings for self-signed certificates
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

airflow_url = '${AIRFLOW_URL}'
dag_id = '${AIRFLOW_DAG_ID}'
username = '${AIRFLOW_USER}'
password = '${AIRFLOW_PASS}'

# Create auth header
auth_string = f'{username}:{password}'
auth_bytes = auth_string.encode('ascii')
auth_b64 = base64.b64encode(auth_bytes).decode('ascii')

# Trigger DAG
trigger_url = f'{airflow_url}/api/v1/dags/{dag_id}/dagRuns'
dag_run_id = f'jenkins_{os.environ.get("BUILD_NUMBER", "manual")}_{int(__import__("time").time())}'

payload = {
    'dag_run_id': dag_run_id,
    'conf': {
        'triggered_by': 'jenkins',
        'build_number': os.environ.get('BUILD_NUMBER', 'unknown'),
        'job_name': os.environ.get('JOB_NAME', 'unknown')
    }
}

headers = {
    'Authorization': f'Basic {auth_b64}',
    'Content-Type': 'application/json'
}

try:
    print(f'Triggering DAG: {dag_id}')
    print(f'URL: {trigger_url}')
    
    response = requests.post(
        trigger_url,
        headers=headers,
        json=payload,
        timeout=30,
        verify=False  # Disable SSL verification for self-signed certificates
    )
    
    response.raise_for_status()
    result = response.json()
    
    print(f'‚úÖ DAG triggered successfully!')
    print(f'   DAG Run ID: {result.get("dag_run_id", dag_run_id)}')
    print(f'   State: {result.get("state", "unknown")}')
    print(f'   View: {airflow_url}/dags/{dag_id}/grid?dag_run_id={result.get("dag_run_id", dag_run_id)}')
    
except requests.exceptions.RequestException as e:
    print(f'‚ùå Failed to trigger DAG: {e}')
    if hasattr(e, 'response') and e.response is not None:
        print(f'   Response: {e.response.text}')
    sys.exit(1)
PYTHON_SCRIPT
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ DAG tested and triggered successfully!"
        }
        failure {
            echo "‚ùå DAG test or trigger failed!"
        }
    }
}